name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy on VM
    runs-on: self-hosted
    environment: Production â€“ alumni-feup

    steps:
      - name: Check API health before deployment
        run: |
          if ! curl -s http://localhost:3010/health; then
            echo "âŒ API is not healthy before deployment"
            exit 1
          fi

      - name: Pull latest backend code and restart
        run: |
          cd ~/newAlumniProj/api
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main

          echo "ğŸ“¦ Installing dependencies..."
          yarn install --frozen-lockfile

          echo "ğŸ”¨ Generating Prisma client..."
          yarn prisma generate

          echo "ğŸ”„ Running migrations..."
          yarn prisma migrate deploy

          echo "ğŸ—ï¸ Building application..."
          yarn build

          echo "ğŸ”„ Restarting API..."
          pm2 restart api --update-env

          # Wait for API to be ready
          echo "â³ Waiting for API to be ready..."
          sleep 5

          # Check if API is healthy after deployment
          if ! curl -s http://localhost:3010/health; then
            echo "âŒ API is not healthy after deployment"
            pm2 logs api --lines 50
            exit 1
          fi

          echo "âœ… Deployment successful!"
